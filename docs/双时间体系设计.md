# 双时间体系设计（本地备忘，不上传云端）

> 记录于 2025-11-12，用于解决「删除后仍显示」与「固定 07:00 重置」两大痛点  
> 仅本地 docs 留存，不随仓库提交，方便后续回顾与微调

---

## 一、背景痛点

1. 删除凭证后，Redis 里仍残留记录 → 文件管理列表“看起来没删干净”  
2. 旧代码依赖 `stats.next_reset_time`（每日 UTC-07:00）→ 用户看到“固定 15:00/07:00”，误以为滚动窗口失效  
3. 用户希望：  
   - 管理页干净（删掉的别再出现）  
   - 统计页完整（删掉的仍参与历史汇总）  
   - 时间语义清晰（别再被硬编码时间误导）

---

## 二、核心思路：双时间体系

| 维度 | 技术视角（真实限流） | 运营视角（人类可读） |
| ---- | -------------------- | -------------------- |
| 时间戳字段 | `state.first_use_timestamp`<br>`state.next_reset_timestamp` | 统一展示日切点（例：06:00） |
| 作用 | 决定单个 key 何时 429/解封 | 决定“今天”总用量、日报 |
| 是否参与调用 | ✅ 直接决定可用池 | ❌ 仅展示，不调逻辑 |
| 是否可配置 | 已固定（24h 滚动） | 可自由设定（06:00 只是建议） |

**一句话记忆**：  
“恢复时间”看 key 自己；“今天用量”看统一 06:00；两条线互不干扰。

---

## 三、删除行为的新语义（软删除 / 归档）

| 动作 | 文件管理页 | 使用统计页 | 是否再调用 |
| ---- | ---------- | ---------- | ---------- |
| 点击“删除” | ❌ 不显示 | ✅ 显示，带“已归档”灰标 | ❌ 不再参与 |
| 实现手段 | `state.archived = true` | 返回全量数据，含 `archived` 标记 | CredentialManager 过滤 `archived` |

**好处**：
- 列表瞬间干净（强迫症治愈）
- 历史数据零丢失（统计完整）
- 代码改动极小（仅增一字段 + 两处过滤）

---

## 四、统一日切点（06:00）落地建议

1. 在 `usage_stats.py` 的 `get_aggregated_stats()` 里固定写死：
   ```python
   daily_anchor = datetime.now(timezone.utc).replace(hour=6, minute=0, second=0, microsecond=0)
   if datetime.now(timezone.utc) < daily_anchor:
       daily_anchor -= timedelta(days=1)
   ```
   返回给前端即可，不参与任何限流判断。

2. 前端控制面板：
   - 文件管理：不显示 `archived` 项
   - 使用统计：顶部加一行小字  
     “今日统计周期：06:00–次日06:00（UTC）”  
     每个卡片仍展示该 key 自己的 `next_reset_timestamp`（滚动恢复时间）

---

## 五、后续可动手清单（本地备忘）

- [ ] 给所有存储后端（Redis/File/...）的 `state` 模板增加 `archived: bool = False`
- [ ] `/creds/action` 的 `delete` 分支改为：
  - 写 `state.archived = true`
  - 可选：清空 `credential` 段（脱敏）
  - 保留 `stats` 段（历史用量）
- [ ] `CredentialManager._discover_credentials()` 过滤 `archived`
- [ ] `/creds/status` 返回时过滤 `archived`（文件管理干净）
- [ ] `/usage/stats` 返回全量，附加 `archived: true` 标记
- [ ] 前端使用统计卡片：对 `archived` 项加灰色“已归档”小标签
- [ ] `usage_stats.py` 的 `get_aggregated_stats()` 里加统一 06:00 日切点并返回
- [ ] 前端顶部加一行小字提示日切周期（见第四节-2）

---

## 六、一句话总结

**删掉的 key 不再烦我，但它用过的数据永远留在统计里；**  
**我自己看“今天”用量，统一 06:00 切割；**  
**系统决定“这个 key 还能不能用”，看它自己的 24h 滚动窗口。**

—— 至此，列表干净、统计完整、时间语义清晰，强迫症与数据洁癖同时治愈。